--[[ Knights adventure remake 0.0.1A.
Listening to black sabath, everything is better, even more programming XD.
I dunno, but i think i'll not use any out-of-normal command library on this thing,
just a matter of time for me to say that. ]]
require "commands"
require "userconfig"
require "battlecommands"


function scl()
	os.execute ("clear")
end

function opening()
  scl()
	print("Kamalcranio (and contribuitors) presents: ")
	delay(3)
	print (colors.blue .. "KNIGHTS ADVENTURE")
	print ("		Knights Adventure, version " .. version)
	print ("------------------------------------------------------------")
	-- There is a file called userconfig, where the damage configs are.
	if major_config == 'default' then
	  print("DAMAGE AND OTHERS OPTIONS ARE ON DEFAULT")
	  print("CHANGE IT ON THE DIFFICULTY (D) MENU")
	  enemy_damage_overall = 5
	  your_damage_overall = 5
	end
	io.write ("\n \n \n \n")
	print("Choose your option: ")
	print(" S - Start game ")	
	print(" D - Difficulty ")
	print(" E - Exit ")
	io.write("Type your option: ")
	opening_option = io.read()
	if opening_option == "s" then
	  newgame()
	elseif opening_option == "d" then
	  options()
	elseif opening_option == "e" then
	  os.exit()
	end
	opening()
--[[ Here i am
	Rock you like a Hurricane
	ayualyuaaah!
	Scorpions. Just scorpions]]--
end

function options()
  print("Enemy damage ratio: " .. enemy_damage_overall)
  print("Your damage: " .. your_damage_overall)
  print("What do you want to do? ")
  print(" 1 - Change it ")
  print(" 2 - Back it up to the default settings")
  print(" 3 - Head back to the main menu")
  difficulty_change = io.read()
  if difficulty_change == "1" then
    -- Opens the userconfig file, and write that the default configs are now disabled.
    userconfig = io.open("userconfig.lua", "w+")
    userconfig:write("major_config = 'user' ")
    io.write("New enemy damage ratio: ")
    -- Same thing as the default config, but with different numbers.
    enemydamage = io.read()
    userconfig:write("enemy_damage_overall = " .. enemydamage .. " ")
    io.write("Your new damage ratio: ")
    yourdamage = io.read()
    userconfig:write("your_damage_overall = " .. yourdamage .. " ")
  elseif difficulty_change == "2" then
    -- Inverse of option 1, no need to explain, right?
    userconfig = io.open("userconfig.lua", "w+")
    userconfig:write("major_config = 'default'")
  elseif difficulty_change == "3" then
    opening()
  end    
end

function newgame()
  scl()
  print("Walking, peacefully...")
  -- The enemy_choose function is on the commands file, it returns a random type of enemy.
  enemy_type = enemy_choose()
  delay(3)
  print("When a enemy type " .. monster.color .. enemy_type .. colors.reset .. " appears!")
  -- No shit, sherlock!
  delay(5)
  enemy_hp = 3000
  your_hp = 3000
  your_mana = 1000
  turn = 0
  firstround = true
  battle_menu()
end

function battle_menu()
  scl()
  -- The if statement below prevents failed counter attack tries getting the new turn bonuses.
  if firstround == false then
    if try_counter ~= true then
      newturn()
    elseif try_counter == true then
      try_counter = false
    end
  end
  firstround = false
  -- The show stats function is on the commands file, it makes easier to see the stats even when in other menus.
  showStats()
  print("What are you going to do?")
  print("A - Attack")
  print("S - Spell")
  print("D - Defend")
  if enemy_attack_state == "miss" and your_attack_state == "defended" then
    counter = true
    print("C - Counter attack")
  elseif sword_stuck == true then
    print("P - Pull sword")
  end
  io.write("Your option: ")
  battle_option = io.read()
  if battle_option == "exitnow" then os.exit() end
  if battle_option == "a" then
    phisical_attack()
  elseif battle_option == "s" then
    spell_menu()
  elseif battle_option == "d" then
    defend()
  elseif battle_option == "c" and counter == true then
    counter_attack()
  elseif battle_option == "c" and counter ~= true then
    print("You can't counter attack him now!")
    try_counter = true
    delay(3)
    battle_menu()
  elseif battle_option == "p" and sword_stuck == true then
    sword_takeout()
  elseif battle_option == "p" and sword_stuck ~= true then
    try_counter = true
    battle_menu()
  elseif battle_option ~= "a" and battle_option ~= "s" and battle_option ~= "d" then
    try_counter = true
    battle_menu()
  end
  
  
end

function phisical_attack()
  scl()
  print("You go, angry, towards the enemy with your sword...")
  delay(3)
  if enemy_type == "fire" then
    print("The sword goes all the way through the fire monster... He stays there, and you sword is hot.")
    print("No damage on him...")
    enemyTurn()
  elseif enemy_type == "water" then
    print("What was i thinking? The sword simply goes trough the water monster, he's fine.")
    print("No damage given")
    enemyTurn()
  elseif enemy_type == "human" then
    print("The man, scared, got seriously wounded! But he stays calm and looks at you with eyes of angry.")
    damage_onenemy()
    print("The enemy loses " .. damage .. "HP!")
    print("Now he has " .. enemy_HP .. "HP.")
    enemyTurn()
  elseif enemy_type == "wood" then
    damage_onenemy()
    print("The enemy loses " .. damage .. "HP!")
    print("Now he has " .. enemy_HP .. "HP.")
    enemyTurn()
    if sword_stuck == true then
      delay(3)
      print("And you sword got stuck on the monster's body!")
      enemyTurn()
    end
  end
end

function spell_menu()
  scl()
  showStats()
  print("You can use one out of these spells: -")
  if your_mana < 100 then
    print("You don't have enough mana to do ANYTHING!")
  end
  if your_mana >= cure.mana then
    print("1 - " .. cure.name .. " - " .. cure.description .. " - " .. cure.mana .. "MP")
  end
  if your_mana >=  lightfire.mana then
    print("2 - " .. lightfire.name .. " - " .. lightfire.description .. " - " .. lightfire.mana .. "MP")
  end
  print("B - Back to the main menu")
  io.write("Your option? ")
  spell_option = io.read()
  if spell_option == "1" and your_mana >= cure.mana then
    cure.spell()
  elseif spell_option == "2" and your_mana >= lightfire.mana then
    lightfire.spell()
  elseif spell_option == "b" or spell_option == "B" then
    firstround = true
    -- The simplest workaround to avoid getting back from the menu and getting the health/mana bonuses.
    battle_menu()
  end
  spell_menu()
end
opening()
  
